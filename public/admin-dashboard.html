<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Pizza&Pasta D'amico</title>
    <link href="css/admin-style.css" rel="stylesheet">
    <link href="css/voice-commands.css" rel="stylesheet">
    <link href="css/weather-integration.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="header-content">
            <h1>üçï Admin Dashboard</h1>
            <div class="header-buttons">
                <button class="btn-secondary" id="voiceToggle">
                    <i class="fas fa-microphone"></i> Eatech Voice
                </button>
                <button class="btn-secondary" onclick="window.location.href='admin-menu-designer.html'">
                    <i class="fas fa-utensils"></i> Speisekarte
                </button>
                <button class="btn-secondary" onclick="openSettings()">
                    <i class="fas fa-cog"></i> Einstellungen
                </button>
                <button class="btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Abmelden
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="admin-container">
        <!-- Status Cards -->
        <div class="status-grid">
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="status-info">
                    <h3>Bestellungen heute</h3>
                    <p class="status-number" id="ordersToday">0</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="status-info">
                    <h3>Wartende Bestellungen</h3>
                    <p class="status-number" id="pendingOrders">0</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-euro-sign"></i>
                </div>
                <div class="status-info">
                    <h3>Umsatz heute</h3>
                    <p class="status-number" id="revenueToday">‚Ç¨0</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-store"></i>
                </div>
                <div class="status-info">
                    <h3>Foodtruck Status</h3>
                    <label class="switch">
                        <input type="checkbox" id="foodtruckToggle" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Wait Time Management -->
        <div class="wait-time-section">
            <h2><i class="fas fa-hourglass-half"></i> Wartezeit Management</h2>
            <div class="wait-time-buttons">
                <button class="wait-btn" data-time="5">
                    <i class="fas fa-rocket"></i>
                    <span>Normal</span>
                    <small>5 Min</small>
                </button>
                <button class="wait-btn" data-time="10">
                    <i class="fas fa-users"></i>
                    <span>Besch√§ftigt</span>
                    <small>10 Min</small>
                </button>
                <button class="wait-btn" data-time="15">
                    <i class="fas fa-fire"></i>
                    <span>Sehr voll</span>
                    <small>15 Min</small>
                </button>
                <button class="wait-btn custom" onclick="setCustomWaitTime()">
                    <i class="fas fa-edit"></i>
                    <span>Custom</span>
                    <small id="customTimeDisplay">-</small>
                </button>
            </div>
            <p class="current-wait">Aktuelle Wartezeit: <strong id="currentWaitDisplay">5</strong> Minuten</p>
        </div>

        <!-- Weather Info Section -->
        <div id="adminWeatherInfo">
            <!-- Wird von weather-integration.js gef√ºllt -->
        </div>

        <!-- Orders Section -->
        <div class="orders-section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> Aktive Bestellungen</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Alle</button>
                    <button class="filter-btn" data-filter="pending">Neu</button>
                    <button class="filter-btn" data-filter="preparing">In Zubereitung</button>
                    <button class="filter-btn" data-filter="ready">Fertig</button>
                </div>
            </div>
            
            <div class="orders-list" id="ordersList">
                <!-- Orders will be loaded here -->
                <div class="no-orders">
                    <i class="fas fa-inbox"></i>
                    <p>Keine aktiven Bestellungen</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Einstellungen</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Sound Settings -->
                <div class="settings-section">
                    <h3><i class="fas fa-volume-up"></i> Sound-Einstellungen</h3>
                    <div class="form-group">
                        <label class="switch">
                            <input type="checkbox" id="enableSounds" checked>
                            <span class="slider round"></span>
                        </label>
                        <label for="enableSounds">Benachrichtigungst√∂ne aktivieren</label>
                    </div>
                </div>

                <!-- Voice Commands Settings -->
                <div class="settings-section">
                    <h3><i class="fas fa-microphone"></i> Eatech Voice Commands</h3>
                    <div class="form-group">
                        <label class="switch">
                            <input type="checkbox" id="autoStartVoice" onchange="saveVoiceSettings()">
                            <span class="slider round"></span>
                        </label>
                        <label for="autoStartVoice">Voice Commands automatisch starten</label>
                    </div>
                    <div class="form-group">
                        <label for="voiceLanguage">Sprache:</label>
                        <select id="voiceLanguage" onchange="changeVoiceLanguage()">
                            <option value="de-DE">Deutsch</option>
                            <option value="en-US">English</option>
                            <option value="it-IT">Italiano</option>
                            <option value="fr-FR">Fran√ßais</option>
                            <option value="es-ES">Espa√±ol</option>
                            <option value="tr-TR">T√ºrk√ße</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn-secondary" onclick="testVoiceCommands()">
                            <i class="fas fa-vial"></i> Voice Test
                        </button>
                        <button class="btn-secondary" onclick="window.eatechVoice.showHelpCommands()">
                            <i class="fas fa-question-circle"></i> Befehle anzeigen
                        </button>
                    </div>
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <p>Sage "Eatech" gefolgt von deinem Befehl. Beispiel: "Eatech, Bestellung 123 fertig"</p>
                    </div>
                </div>

                <!-- WhatsApp Settings Section -->
                <div class="settings-section">
                    <h3><i class="fab fa-whatsapp"></i> WhatsApp Integration</h3>
                    
                    <!-- Enable/Disable -->
                    <div class="form-group">
                        <label class="switch">
                            <input type="checkbox" id="whatsappEnabled" onchange="saveWhatsAppSettings()">
                            <span class="slider round"></span>
                        </label>
                        <label for="whatsappEnabled">WhatsApp-Benachrichtigungen aktivieren</label>
                    </div>
                    
                    <!-- Business Number -->
                    <div class="form-group">
                        <label for="businessNumber">Ihre WhatsApp Business Nummer:</label>
                        <div class="input-group">
                            <select id="businessCountryCode" onchange="saveWhatsAppSettings()">
                                <option value="+41">üá®üá≠ +41</option>
                                <option value="+49">üá©üá™ +49</option>
                                <option value="+43">üá¶üáπ +43</option>
                                <option value="+39">üáÆüáπ +39</option>
                                <option value="+33">üá´üá∑ +33</option>
                            </select>
                            <input type="tel" 
                                   id="businessNumber" 
                                   placeholder="79 123 45 67"
                                   onchange="saveWhatsAppSettings()">
                        </div>
                    </div>
                    
                    <!-- API Configuration (Optional) -->
                    <details class="advanced-settings">
                        <summary>Erweiterte Einstellungen</summary>
                        <div class="form-group">
                            <label for="whatsappApiUrl">Business API URL (optional):</label>
                            <input type="url" 
                                   id="whatsappApiUrl" 
                                   placeholder="https://api.twilio.com/..."
                                   onchange="saveWhatsAppSettings()">
                            <small>F√ºr automatischen Versand ohne Browser-Popup</small>
                        </div>
                    </details>
                    
                    <!-- Test & Stats -->
                    <div class="whatsapp-actions">
                        <button class="btn-secondary" onclick="testWhatsAppMessage()">
                            <i class="fab fa-whatsapp"></i> Test-Nachricht
                        </button>
                        <button class="btn-secondary" onclick="showWhatsAppStats()">
                            <i class="fas fa-chart-line"></i> Statistiken
                        </button>
                    </div>
                    
                    <!-- Stats Display -->
                    <div id="whatsappStats" class="stats-box" style="display: none;">
                        <h4>WhatsApp Statistiken</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">Heute gesendet:</span>
                                <span class="stat-value" id="whatsappToday">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Gesamt:</span>
                                <span class="stat-value" id="whatsappTotal">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Erfolgsrate:</span>
                                <span class="stat-value" id="whatsappSuccess">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <p>Kunden erhalten automatische WhatsApp-Updates zu ihrer Bestellung. 
                           Funktioniert ohne App-Installation direkt √ºber WhatsApp Web.</p>
                    </div>
                </div>

                <!-- Weather Settings Section -->
                <div id="weatherSettingsContainer">
                    <!-- Wird dynamisch von weatherIntegration.createSettingsUI() gef√ºllt -->
                </div>

                <!-- Auto-Archiv -->
                <div class="settings-section">
                    <h3><i class="fas fa-archive"></i> Auto-Archivierung</h3>
                    <div class="form-group">
                        <label for="archiveTime">Bestellungen archivieren nach:</label>
                        <select id="archiveTime">
                            <option value="5">5 Minuten</option>
                            <option value="10">10 Minuten</option>
                            <option value="15">15 Minuten</option>
                            <option value="30">30 Minuten</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD3OCMvc4Iup58Ao0BiFNuvA0fnJokzYS8",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.firebasestorage.app",
            messagingSenderId: "83240541532",
            appId: "1:83240541532:web:11e3277850bf89a5b8b599",
            measurementId: "G-6H2J5K88J7"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <!-- Scripts -->
    <script src="js/voice-commands.js"></script>
    <script src="js/whatsapp-integration.js"></script>
    <script src="js/weather-integration.js"></script>

    <!-- Main Admin Script -->
    <script>
        // Global Variables
        let currentWaitTime = 5;
        let soundEnabled = true;
        let ordersRef = database.ref('orders');
        let settingsRef = database.ref('settings');
        let activeOrders = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadSettings();
            initializeEventListeners();
            loadOrders();
            updateStats();
            startRealtimeUpdates();
            initializeVoiceCommands();
            
            // Weather Settings laden
            if (window.weatherIntegration) {
                const weatherSettingsContainer = document.getElementById('weatherSettingsContainer');
                if (weatherSettingsContainer) {
                    weatherSettingsContainer.innerHTML = window.weatherIntegration.createSettingsUI();
                }
            }
        });

        // Voice Commands Integration
        function initializeVoiceCommands() {
            if (window.FlowBiteVoiceCommands) {
                window.eatechVoice = new FlowBiteVoiceCommands();
                window.eatechVoice.wakeWord = 'eatech';
                window.eatechVoice.createFeedbackUI();
                
                // Multi-Language Support
                const savedLanguage = localStorage.getItem('voiceLanguage') || 'de-DE';
                document.getElementById('voiceLanguage').value = savedLanguage;
                window.eatechVoice.setLanguage(savedLanguage);
                
                // Voice Toggle Button
                document.getElementById('voiceToggle').addEventListener('click', function() {
                    window.eatechVoice.toggle();
                    this.classList.toggle('active');
                });
                
                // Auto-Start wenn aktiviert
                const autoStart = localStorage.getItem('autoStartVoice') === 'true';
                if (autoStart) {
                    setTimeout(() => {
                        window.eatechVoice.start();
                        document.getElementById('voiceToggle').classList.add('active');
                    }, 2000);
                }
                
                // Status Change Callback
                window.eatechVoice.onStatusChange((orderId, newStatus) => {
                    const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
                    if (orderCard) {
                        updateOrderUI(orderCard, { status: newStatus });
                    }
                });
            }
        }

        // Voice Settings Functions
        function saveVoiceSettings() {
            const autoStart = document.getElementById('autoStartVoice').checked;
            localStorage.setItem('autoStartVoice', autoStart);
        }

        function changeVoiceLanguage() {
            const language = document.getElementById('voiceLanguage').value;
            localStorage.setItem('voiceLanguage', language);
            if (window.eatechVoice) {
                window.eatechVoice.setLanguage(language);
                if (window.eatechVoice.isListening) {
                    window.eatechVoice.stop();
                    setTimeout(() => window.eatechVoice.start(), 500);
                }
            }
        }

        function testVoiceCommands() {
            if (window.eatechVoice) {
                const lang = document.getElementById('voiceLanguage').value;
                let testMessage = '';
                switch(lang) {
                    case 'de-DE': testMessage = 'Voice Test: Sage jetzt "Eatech, Hilfe"'; break;
                    case 'en-US': testMessage = 'Voice Test: Say "Eatech, help" now'; break;
                    case 'it-IT': testMessage = 'Test vocale: D√¨ "Eatech, aiuto"'; break;
                    case 'fr-FR': testMessage = 'Test vocal: Dites "Eatech, aide"'; break;
                    case 'es-ES': testMessage = 'Prueba de voz: Di "Eatech, ayuda"'; break;
                    case 'tr-TR': testMessage = 'Ses testi: "Eatech, yardƒ±m" deyin'; break;
                }
                window.eatechVoice.showNotification(testMessage, 'info');
                window.eatechVoice.start();
            }
        }

        // WhatsApp Settings laden
        function loadWhatsAppSettings() {
            const settings = JSON.parse(localStorage.getItem('whatsappSettings') || '{}');
            
            document.getElementById('whatsappEnabled').checked = settings.enabled || false;
            document.getElementById('businessCountryCode').value = settings.countryCode || '+41';
            document.getElementById('businessNumber').value = settings.businessNumber || '';
            document.getElementById('whatsappApiUrl').value = settings.apiUrl || '';
        }

        // WhatsApp Settings speichern
        function saveWhatsAppSettings() {
            const settings = {
                enabled: document.getElementById('whatsappEnabled').checked,
                countryCode: document.getElementById('businessCountryCode').value,
                businessNumber: document.getElementById('businessNumber').value,
                apiUrl: document.getElementById('whatsappApiUrl').value
            };
            
            window.whatsApp.saveSettings(settings);
            showNotification('WhatsApp-Einstellungen gespeichert', 'success');
        }

        // Test-Nachricht senden
        async function testWhatsAppMessage() {
            const businessNumber = document.getElementById('businessNumber').value;
            const countryCode = document.getElementById('businessCountryCode').value;
            
            if (!businessNumber) {
                showNotification('Bitte erst Business-Nummer eingeben', 'warning');
                return;
            }
            
            const testOrder = {
                orderNumber: 'TEST-' + Math.floor(Math.random() * 1000),
                customerName: 'Test-Kunde',
                phoneNumber: countryCode + businessNumber.replace(/\s/g, ''),
                items: [
                    { name: 'Pizza Margherita', quantity: 1, price: 18.50 }
                ],
                total: 18.50,
                estimatedWaitTime: 15,
                pickupLocation: 'Foodtruck am Marktplatz'
            };
            
            await window.whatsApp.sendOrderConfirmation(testOrder, 'de');
            showNotification('Test-Nachricht wird gesendet...', 'info');
        }

        // WhatsApp Statistiken anzeigen
        function showWhatsAppStats() {
            const stats = window.whatsApp.getStatistics();
            
            document.getElementById('whatsappToday').textContent = stats.today;
            document.getElementById('whatsappTotal').textContent = stats.total;
            document.getElementById('whatsappSuccess').textContent = stats.successRate.toFixed(1) + '%';
            
            document.getElementById('whatsappStats').style.display = 'block';
        }

        // Auth Check
        function checkAuth() {
            const adminToken = localStorage.getItem('adminToken');
            if (!adminToken) {
                window.location.href = 'admin.html';
                return;
            }
        }

        // Load Settings
        function loadSettings() {
            // Sound Settings
            const savedSound = localStorage.getItem('enableSounds');
            soundEnabled = savedSound !== 'false';
            document.getElementById('enableSounds').checked = soundEnabled;
            
            // Voice Settings
            const autoStartVoice = localStorage.getItem('autoStartVoice') === 'true';
            document.getElementById('autoStartVoice').checked = autoStartVoice;
            
            // WhatsApp Settings
            loadWhatsAppSettings();
            
            // Archive Time
            const archiveTime = localStorage.getItem('archiveTime') || '5';
            document.getElementById('archiveTime').value = archiveTime;
            
            // Wait Time from Firebase
            settingsRef.child('waitTime').on('value', snapshot => {
                currentWaitTime = snapshot.val() || 5;
                updateWaitTimeDisplay();
            });
            
            // Foodtruck Status
            settingsRef.child('isOpen').on('value', snapshot => {
                const isOpen = snapshot.val() !== false;
                document.getElementById('foodtruckToggle').checked = isOpen;
            });
        }

        // Event Listeners
        function initializeEventListeners() {
            // Wait Time Buttons
            document.querySelectorAll('.wait-btn:not(.custom)').forEach(btn => {
                btn.addEventListener('click', function() {
                    const time = parseInt(this.dataset.time);
                    setWaitTime(time);
                });
            });
            
            // Filter Buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterOrders(this.dataset.filter);
                });
            });
            
            // Foodtruck Toggle
            document.getElementById('foodtruckToggle').addEventListener('change', function() {
                settingsRef.child('isOpen').set(this.checked);
                showNotification(this.checked ? 'Foodtruck ge√∂ffnet' : 'Foodtruck geschlossen', 
                               this.checked ? 'success' : 'warning');
            });
            
            // Sound Toggle
            document.getElementById('enableSounds').addEventListener('change', function() {
                soundEnabled = this.checked;
                localStorage.setItem('enableSounds', soundEnabled);
            });
            
            // Archive Time
            document.getElementById('archiveTime').addEventListener('change', function() {
                localStorage.setItem('archiveTime', this.value);
            });
        }

        // Load Orders
        function loadOrders() {
            ordersRef.orderByChild('status').on('value', snapshot => {
                const orders = snapshot.val() || {};
                const ordersList = document.getElementById('ordersList');
                
                // Clear list
                ordersList.innerHTML = '';
                
                // Convert to array and sort
                const ordersArray = Object.entries(orders).map(([id, order]) => ({
                    id,
                    ...order
                }));
                
                // Sort by timestamp (newest first)
                ordersArray.sort((a, b) => b.timestamp - a.timestamp);
                
                if (ordersArray.length === 0) {
                    ordersList.innerHTML = `
                        <div class="no-orders">
                            <i class="fas fa-inbox"></i>
                            <p>Keine aktiven Bestellungen</p>
                        </div>
                    `;
                    return;
                }
                
                // Render orders
                ordersArray.forEach(order => {
                    if (order.status !== 'archived') {
                        const orderCard = createOrderCard(order);
                        ordersList.appendChild(orderCard);
                    }
                });
                
                // Update stats
                updateStats();
                
                // Check for new orders
                checkForNewOrders(orders);
            });
        }

        // Create Order Card
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card ${order.status}`;
            card.dataset.orderId = order.id;
            card.dataset.status = order.status;
            card.dataset.orderNumber = order.orderNumber;
            
            const waitTime = calculateWaitTime(order);
            const statusIcon = getStatusIcon(order.status);
            const statusText = getStatusText(order.status);
            
            card.innerHTML = `
                <div class="order-header">
                    <div class="order-number">#${order.orderNumber}</div>
                    <div class="order-time">${formatTime(order.timestamp)}</div>
                </div>
                
                <div class="order-customer">
                    <i class="fas fa-user"></i> ${order.customerName || 'Gast'}
                    ${order.phoneNumber ? `<span class="phone"><i class="fas fa-phone"></i> ${order.phoneNumber}</span>` : ''}
                </div>
                
                <div class="order-items">
                    ${order.items.map(item => `
                        <div class="order-item">
                            <span>${item.quantity}x ${item.name}</span>
                            <span>‚Ç¨${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="order-footer">
                    <div class="order-total">
                        <strong>Gesamt: ‚Ç¨${order.total.toFixed(2)}</strong>
                    </div>
                    <div class="order-wait-time">
                        <i class="fas fa-clock"></i> ${waitTime} Min
                    </div>
                </div>
                
                <div class="order-status">
                    ${statusIcon} ${statusText}
                </div>
                
                <div class="order-actions">
                    ${getOrderActions(order.status, order.id)}
                </div>
            `;
            
            return card;
        }

        // Get Order Actions
        function getOrderActions(status, orderId) {
            const order = activeOrders[orderId];
            const hasWhatsApp = order && order.phoneNumber && order.whatsappConsent;
            
            let actions = '';
            
            switch(status) {
                case 'pending':
                    actions = `
                        <button class="btn-primary" onclick="updateOrderStatus('${orderId}', 'preparing')">
                            <i class="fas fa-fire"></i> Zubereitung starten
                        </button>
                        <button class="btn-danger" onclick="cancelOrder('${orderId}')">
                            <i class="fas fa-times"></i> Stornieren
                        </button>
                    `;
                    break;
                case 'preparing':
                    actions = `
                        <button class="btn-success" onclick="updateOrderStatus('${orderId}', 'ready')">
                            <i class="fas fa-check"></i> Fertig
                        </button>
                    `;
                    break;
                case 'ready':
                    actions = `
                        <button class="btn-primary" onclick="completeOrder('${orderId}')">
                            <i class="fas fa-hand-holding"></i> Abgeholt
                        </button>
                        <button class="btn-warning" onclick="callCustomer('${orderId}')">
                            <i class="fas fa-bell"></i> Kunde rufen
                        </button>
                    `;
                    break;
            }
            
            // WhatsApp Quick Action
            if (hasWhatsApp) {
                actions += `
                    <button class="btn-whatsapp" onclick="quickWhatsApp('${orderId}')" title="WhatsApp senden">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                `;
            }
            
            return actions;
        }

        // Update Order Status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                await ordersRef.child(orderId).update({
                    status: newStatus,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                const order = activeOrders[orderId];
                if (order) {
                    // WhatsApp-Benachrichtigung
                    if (order.phoneNumber && order.whatsappConsent) {
                        window.whatsApp.sendStatusUpdate(order, newStatus, order.language || 'de');
                    }
                    
                    // Visual feedback
                    showNotification(`Bestellung #${order.orderNumber} ‚Üí ${getStatusText(newStatus)}`, 'success');
                    
                    // Sound feedback
                    if (soundEnabled && newStatus === 'ready') {
                        playNotificationSound();
                    }
                }
            } catch (error) {
                console.error('Error updating order:', error);
                showNotification('Fehler beim Aktualisieren', 'error');
            }
        }

        // Complete Order
        async function completeOrder(orderId) {
            try {
                const archiveTime = parseInt(localStorage.getItem('archiveTime') || '5');
                
                await ordersRef.child(orderId).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Auto-archive after X minutes
                setTimeout(() => {
                    archiveOrder(orderId);
                }, archiveTime * 60 * 1000);
                
                showNotification('Bestellung abgeschlossen', 'success');
            } catch (error) {
                console.error('Error completing order:', error);
                showNotification('Fehler beim Abschlie√üen', 'error');
            }
        }

        // Archive Order
        async function archiveOrder(orderId) {
            try {
                const snapshot = await ordersRef.child(orderId).once('value');
                const order = snapshot.val();
                
                if (order) {
                    // Move to archive
                    await database.ref(`archive/${orderId}`).set({
                        ...order,
                        archivedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Remove from active orders
                    await ordersRef.child(orderId).remove();
                }
            } catch (error) {
                console.error('Error archiving order:', error);
            }
        }

        // Call Customer
        async function callCustomer(orderId) {
            const order = activeOrders[orderId];
            if (!order) return;
            
            // Update notification level
            await ordersRef.child(orderId).update({
                notificationLevel: 3,
                lastNotification: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Send urgent notification
            if (order.phoneNumber) {
                // WhatsApp reminder
                if (order.whatsappConsent && window.whatsApp) {
                    window.whatsApp.sendReminder(order, order.language || 'de');
                }
            }
            
            // Visual feedback
            showNotification(`Kunde #${order.orderNumber} wird gerufen`, 'warning');
            
            // Sound alert
            if (soundEnabled) {
                playUrgentSound();
            }
        }

        // Cancel Order
        async function cancelOrder(orderId) {
            if (!confirm('Bestellung wirklich stornieren?')) return;
            
            try {
                await ordersRef.child(orderId).update({
                    status: 'cancelled',
                    cancelledAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                showNotification('Bestellung storniert', 'warning');
            } catch (error) {
                console.error('Error cancelling order:', error);
                showNotification('Fehler beim Stornieren', 'error');
            }
        }

        // Quick WhatsApp
        function quickWhatsApp(orderId) {
            const order = activeOrders[orderId];
            if (!order) return;
            
            const message = prompt('Nachricht an Kunde:', 'Ihre Bestellung ist gleich fertig!');
            if (message) {
                const customMessage = window.whatsApp.buildQuickMessage(order, 'custom', message);
                window.whatsApp.sendMessage(order.phoneNumber, customMessage);
            }
        }

        // Filter Orders
        function filterOrders(filter) {
            const orderCards = document.querySelectorAll('.order-card');
            
            orderCards.forEach(card => {
                if (filter === 'all' || card.dataset.status === filter) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Update Stats
        function updateStats() {
            // Orders today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            ordersRef.orderByChild('timestamp').startAt(today.getTime()).once('value', snapshot => {
                const orders = snapshot.val() || {};
                const ordersArray = Object.values(orders);
                
                // Count orders
                document.getElementById('ordersToday').textContent = ordersArray.length;
                
                // Count pending
                const pending = ordersArray.filter(o => o.status === 'pending' || o.status === 'preparing').length;
                document.getElementById('pendingOrders').textContent = pending;
                
                // Calculate revenue
                const revenue = ordersArray.reduce((sum, order) => sum + (order.total || 0), 0);
                document.getElementById('revenueToday').textContent = `‚Ç¨${revenue.toFixed(2)}`;
            });
        }

        // Wait Time Management
        function setWaitTime(minutes) {
            currentWaitTime = minutes;
            settingsRef.child('baseWaitTime').set(minutes);
            
            // If weather integration is active, it will adjust the actual wait time
            if (!window.weatherIntegration || !window.weatherIntegration.config.enabled) {
                settingsRef.child('waitTime').set(minutes);
            }
            
            updateWaitTimeDisplay();
            showNotification(`Basis-Wartezeit auf ${minutes} Minuten gesetzt`, 'success');
        }

        function setCustomWaitTime() {
            const time = prompt('Wartezeit in Minuten:', currentWaitTime);
            if (time && !isNaN(time)) {
                setWaitTime(parseInt(time));
                document.getElementById('customTimeDisplay').textContent = time + ' Min';
            }
        }

        function updateWaitTimeDisplay() {
            document.getElementById('currentWaitDisplay').textContent = currentWaitTime;
            
            // Update button states
            document.querySelectorAll('.wait-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.time == currentWaitTime) {
                    btn.classList.add('active');
                }
            });
        }

        // Calculate Wait Time for Order
        function calculateWaitTime(order) {
            const index = Object.values(activeOrders)
                .filter(o => o.status === 'pending' || o.status === 'preparing')
                .sort((a, b) => a.timestamp - b.timestamp)
                .findIndex(o => o.id === order.id);
            
            let baseTime = currentWaitTime * (index + 1);
            
            // Apply weather multiplier if available
            if (window.weatherIntegration && window.weatherIntegration.weatherMultiplier) {
                baseTime = Math.round(baseTime * window.weatherIntegration.weatherMultiplier);
            }
            
            return baseTime;
        }

        // Check for New Orders
        function checkForNewOrders(orders) {
            Object.entries(orders).forEach(([id, order]) => {
                if (!activeOrders[id] && order.status === 'pending') {
                    // New order detected
                    if (soundEnabled) {
                        playNotificationSound();
                    }
                    showNotification(`Neue Bestellung #${order.orderNumber}`, 'info');
                }
            });
            
            activeOrders = orders;
        }

        // Sounds
        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCRy0w8JNFgEMUajv7MJfIAUlmNPvv4I/CwBHtPLy0YM+');
            audio.volume = 0.3;
            audio.play();
        }

        function playUrgentSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRrgCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YZQCAADcq3AX/vbx0aJkJgUA8vLy8vLy8sGMOgEA+/r6+vr6+vqkVgsBAP7+/v7+/v7+uGANAQD//////+/DaRUBAO3t7e3t7e3t7dmeVhEA6Ojo6Ojo6Oi+ek4fAOHh4eHh4dKAUjQWANra2tra0H5KPj4qBMrKysq+dUI0PD48LwW4uLiidEA2PDw8PCsDpqZ+akAwOTk5OTkrBJCQaFcoLi4uLi4uGwl3aEgkJCQkJCQkIhFUQyEZGRkZGRkZGQ');
            audio.volume = 0.5;
            audio.play();
        }

        // UI Helpers
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        function getStatusIcon(status) {
            const icons = {
                pending: '<i class="fas fa-clock"></i>',
                preparing: '<i class="fas fa-fire"></i>',
                ready: '<i class="fas fa-check-circle"></i>',
                completed: '<i class="fas fa-check-double"></i>',
                cancelled: '<i class="fas fa-times-circle"></i>'
            };
            return icons[status] || '';
        }

        function getStatusText(status) {
            const texts = {
                pending: 'Neu',
                preparing: 'In Zubereitung',
                ready: 'Fertig',
                completed: 'Abgeholt',
                cancelled: 'Storniert'
            };
            return texts[status] || status;
        }

        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin.html';
        }

        // Start Realtime Updates
        function startRealtimeUpdates() {
            // Update stats every minute
            setInterval(updateStats, 60000);
        }

        // Update Order UI (for Voice Commands)
        function updateOrderUI(orderElement, updates) {
            if (updates.status) {
                // Update status class
                orderElement.className = `order-card ${updates.status}`;
                orderElement.dataset.status = updates.status;
                
                // Update status display
                const statusEl = orderElement.querySelector('.order-status');
                statusEl.innerHTML = `${getStatusIcon(updates.status)} ${getStatusText(updates.status)}`;
                
                // Update actions
                const actionsEl = orderElement.querySelector('.order-actions');
                actionsEl.innerHTML = getOrderActions(updates.status, orderElement.dataset.orderId);
                
                // Voice feedback
                if (window.eatechVoice) {
                    const orderNumber = orderElement.querySelector('.order-number').textContent.replace('#', '');
                    let message = '';
                    
                    switch(updates.status) {
                        case 'preparing':
                            message = `Bestellung ${orderNumber} wird zubereitet`;
                            break;
                        case 'ready':
                            message = `Bestellung ${orderNumber} ist fertig!`;
                            playNotificationSound();
                            break;
                    }
                    
                    if (message && 'speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(message);
                        utterance.lang = document.getElementById('voiceLanguage').value;
                        utterance.rate = 1.1;
                        speechSynthesis.speak(utterance);
                    }
                }
            }
        }
    </script>

    <!-- Additional Styles -->
    <style>
        /* Voice Toggle Button Active State */
        #voiceToggle.active {
            background: #3b82f6;
            color: white;
        }
        
        #voiceToggle.active i {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .toast.error {
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .toast.warning {
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .toast.info {
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .toast i {
            font-size: 20px;
        }
        
        .toast.success i { color: #22c55e; }
        .toast.error i { color: #ef4444; }
        .toast.warning i { color: #f59e0b; }
        .toast.info i { color: #3b82f6; }
        
        /* WhatsApp Button */
        .btn-whatsapp {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-whatsapp:hover {
            background: #128C7E;
        }
        
        /* Stats Box */
        .stats-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 20px;
            font-weight: bold;
            color: #3b82f6;
        }
        
        /* Input Group */
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group select {
            width: 120px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        /* Advanced Settings */
        .advanced-settings {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
        }
        
        .advanced-settings summary {
            cursor: pointer;
            font-weight: 500;
            color: #9ca3af;
        }
        
        /* WhatsApp Actions */
        .whatsapp-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
    </style>
</body>
</html>