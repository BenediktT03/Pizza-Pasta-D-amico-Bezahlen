<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza&Pasta D'amico - Authentische italienische K√ºche</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            color: #ffffff;
            padding: 10px;
        }

        /* PIZZA LOADING ANIMATION */
        .pizza-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .pizza-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinning-pizza {
            font-size: 4rem;
            animation: spin 2s linear infinite;
            margin-bottom: 30px;
        }

        .loading-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* WARTEZEIT BANNER - NEU */
        .wait-time-banner {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
            animation: pulse 2s infinite;
        }

        .wait-time-banner.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .wait-time-banner.busy {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05);
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3730a3 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .location-info {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-badges {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-badge {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .content {
            padding: 40px 30px;
        }

        .products-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }

        .product-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .product-emoji {
            width: 64px;
            height: 64px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .product-details h3 {
            color: #ffffff;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .product-price {
            color: #22c55e;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .product-description {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .quantity-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            min-width: 30px;
            text-align: center;
        }

        .cart-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            display: none;
        }

        .cart-section.visible {
            display: block;
        }

        .cart-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .cart-header h3 {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .cart-item-details {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        .cart-item-price {
            color: #22c55e;
            font-weight: 600;
            font-size: 1rem;
        }

        .cart-totals {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .cart-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .cart-total-row.final {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0;
        }

        .note-section {
            margin-bottom: 20px;
        }

        .note-section h3 {
            color: #ffffff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .note-input {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .note-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .order-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 24px;
        }

        .order-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
        }

        .order-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            color: rgba(255, 255, 255, 0.5);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .status-message {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            margin: 20px 0;
        }

        .status-emoji {
            font-size: 4rem;
            margin-bottom: 24px;
            opacity: 0.8;
        }

        .status-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #ffffff;
        }

        .admin-section {
            text-align: center;
            margin-top: 50px;
            padding: 30px 20px;
            border-top: 2px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
        }

        .admin-button {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            color: #000000;
            padding: 18px 32px;
            border-radius: 14px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: 700;
        }

        .admin-button:hover {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 20px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Pizza Loading Screen -->
    <div class="pizza-loader" id="pizzaLoader">
        <div class="spinning-pizza">üçï</div>
        <div class="loading-text">Pizza&Pasta D'amico</div>
        <div class="loading-subtext">Lade k√∂stliche Speisekarte...</div>
    </div>

    <!-- Wartezeit Banner -->
    <div class="wait-time-banner" id="waitTimeBanner" style="display: none;">
        <i class="fas fa-clock"></i> 
        <span id="waitTimeText">Aktuelle Wartezeit: 5 Minuten</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üçï Pizza&Pasta D'amico</h1>
            <p class="subtitle">Authentische italienische K√ºche</p>
            <div class="location-info" id="locationInfo">
                <i class="fas fa-truck"></i>
                <span>Foodtruck ‚Ä¢ Abholung</span>
            </div>
            <div class="status-badges">
                <div class="status-badge" id="statusBadge">
                    <i class="fas fa-circle"></i> <span id="statusText">Wird geladen...</span>
                </div>
                <div class="status-badge" style="background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.3); color: #60a5fa;">
                    <i class="fas fa-clock"></i> <span id="prepTime">5 Min</span>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Status wenn geschlossen -->
            <div class="status-message" id="closedMessage" style="display: none;">
                <div class="status-emoji">üò¥</div>
                <h2 class="status-title">Foodtruck geschlossen</h2>
                <p style="color: rgba(255, 255, 255, 0.7);">Wir sind gerade geschlossen. Schauen Sie sp√§ter wieder vorbei!</p>
            </div>

            <!-- Produkte -->
            <div class="section" id="productsSection">
                <div class="products-grid" id="productsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Speisekarte wird geladen...</p>
                    </div>
                </div>
            </div>

            <!-- Warenkorb -->
            <div class="cart-section" id="cartSection">
                <div class="cart-header">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Ihre Bestellung</h3>
                </div>
                <div id="cartItems"></div>
                <div class="cart-totals">
                    <div class="cart-total-row final">
                        <span>Gesamttotal</span>
                        <span id="totalPrice">CHF 0.00</span>
                    </div>
                </div>
            </div>

            <!-- Notizen -->
            <div class="note-section" style="display: none;" id="noteSection">
                <h3>
                    <i class="fas fa-comment"></i> Besondere W√ºnsche
                </h3>
                <textarea 
                    id="orderNote" 
                    class="note-input" 
                    placeholder="z.B. extra scharf, ohne Zwiebeln..."
                ></textarea>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="color: rgba(255,255,255,0.8);">Bestellung wird verarbeitet...</p>
            </div>

            <!-- Bestellen Button -->
            <button class="order-btn" id="orderBtn" disabled>
                <i class="fas fa-shopping-cart"></i> Produkt ausw√§hlen
            </button>

            <!-- Admin Section -->
            <div class="admin-section">
                <button class="admin-button" onclick="goToLogin()">
                    üõ°Ô∏è Pietro Admin Login
                </button>
                <p style="color: rgba(255,255,255,0.6); margin-top: 12px; font-size: 0.9rem;">Zur Admin-Anmeldung</p>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check"></i> Benachrichtigung
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3OCMvc4Iup58Ao0BiFNuvA0fnJokzYS8",
            authDomain: "pizzapastadamico.firebaseapp.com",
            databaseURL: "https://pizzapastadamico-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pizzapastadamico",
            storageBucket: "pizzapastadamico.firebasestorage.app",
            messagingSenderId: "83240541532",
            appId: "1:83240541532:web:11e3277850bf89a5b8b599",
            measurementId: "G-6H2J5K88J7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const stripe = Stripe('pk_test_51Rg6MY4I9wcGYX9JUBunT1Yh6kr776piJvLCk3Ln6ovyk0RGBQ0icKbbEYvOUInOIZGKdbvfsCPLZ14JDoOlrPeV00SJRbRsDo');

        // App State
        let foodtruckOpen = false;
        let availableProducts = {};
        let cart = {};

        // ===== NEUE FEATURES =====

        // 1. PRODUKTBASIERTE WARTEZEIT-BERECHNUNG
        function calculateWaitTime(totalProducts) {
            if (totalProducts < 6) {
                return { min: 5, max: 5, text: '5', level: 'normal' };
            } else if (totalProducts < 12) {
                return { min: 10, max: 10, text: '10', level: 'busy' };
            } else {
                const extraGroups = Math.floor((totalProducts - 6) / 6);
                const extraMinMin = extraGroups * 5;
                const extraMinMax = extraGroups * 10;
                const totalMin = 10 + extraMinMin;
                const totalMax = 10 + extraMinMax;
                
                return { 
                    min: totalMin, 
                    max: totalMax, 
                    text: totalMin === totalMax ? `${totalMin}` : `${totalMin}-${totalMax}`,
                    level: 'very_busy'
                };
            }
        }

        // 2. GESAMTANZAHL AKTIVER PRODUKTE BERECHNEN
        function getTotalActiveProducts() {
            return database.ref('orders').once('value').then((snapshot) => {
                const orders = snapshot.val() || {};
                const activeOrders = Object.values(orders).filter(order => 
                    order.status === 'neu' || order.status === 'zubereitung'
                );
                
                return activeOrders.reduce((total, order) => {
                    if (order.items) {
                        return total + order.items.reduce((sum, item) => sum + item.quantity, 0);
                    } else {
                        return total + 1; // Alte Struktur
                    }
                }, 0);
            });
        }

        // 3. WARTEZEIT-BANNER AKTUALISIEREN (mit Admin-Sync)
        function updateWaitTimeBanner(totalProducts) {
            const banner = document.getElementById('waitTimeBanner');
            const text = document.getElementById('waitTimeText');
            const prepTime = document.getElementById('prepTime');
            
            // Pr√ºfe ob Admin manuelle Zeit gesetzt hat
            database.ref('settings/waitTime').once('value', (snapshot) => {
                const settings = snapshot.val();
                let waitTime;
                
                if (settings && settings.mode === 'manual') {
                    waitTime = { text: settings.time, level: 'normal' };
                } else {
                    waitTime = calculateWaitTime(totalProducts);
                }
                
                banner.className = 'wait-time-banner';
                if (waitTime.level === 'busy') {
                    banner.classList.add('warning');
                } else if (waitTime.level === 'very_busy') {
                    banner.classList.add('busy');
                }
                
                text.textContent = `Aktuelle Wartezeit: ${waitTime.text} Minuten`;
                prepTime.textContent = `${waitTime.text} Min`;
                
                if (foodtruckOpen) {
                    banner.style.display = 'block';
                }
            });
        }

        // 4. PRODUKTANZAHL √úBERWACHEN
        function monitorProductCount() {
            database.ref('orders').on('value', async (snapshot) => {
                const totalProducts = await getTotalActiveProducts();
                updateWaitTimeBanner(totalProducts);
                console.log(`Aktive Produkte in Zubereitung: ${totalProducts}`);
            });
        }

        // 5. ADMIN-WARTEZEIT-EINSTELLUNGEN √úBERWACHEN
        function monitorAdminWaitTimeSettings() {
            database.ref('settings/waitTime').on('value', (snapshot) => {
                getTotalActiveProducts().then(totalProducts => {
                    updateWaitTimeBanner(totalProducts);
                });
            });
        }

        // 6. PUSH-BENACHRICHTIGUNGEN EINRICHTEN
        async function setupPushNotifications() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('Push-Benachrichtigungen aktiviert');
                        return true;
                    }
                } catch (error) {
                    console.log('Push-Benachrichtigungen nicht verf√ºgbar');
                }
            }
            return false;
        }

        // 7. BESTELLSTATUS √úBERWACHEN (f√ºr Benachrichtigungen)
        function monitorOrderStatus(orderId) {
            database.ref(`orders/${orderId}`).on('value', (snapshot) => {
                const order = snapshot.val();
                if (!order) return;
                
                const notification = order.customerNotification;
                
                if (notification && !notification.read) {
                    // Browser-Benachrichtigung
                    if (Notification.permission === 'granted') {
                        const icon = order.status === 'fertig' ? 'üçï' : 'üë®‚Äçüç≥';
                        new Notification(`${icon} ${notification.message}`, {
                            body: `Bestellung #${orderId.slice(-6)}`,
                            icon: '/favicon.ico',
                            tag: orderId
                        });
                    }
                    
                    // In-App Benachrichtigung
                    const notifType = order.status === 'fertig' ? 'success' : 'info';
                    showNotification(notification.message, notifType);
                    
                    // Akustisches Signal nur wenn playSound = true
                    if (notification.playSound) {
                        playNotificationSound();
                    }
                    
                    // Benachrichtigung als gelesen markieren
                    database.ref(`orders/${orderId}/customerNotification/read`).set(true);
                }
            });
        }

        // 8. BENACHRICHTIGUNGSTON ABSPIELEN
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.4);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.log('Audio nicht verf√ºgbar');
            }
        }

        // ===== URSPR√úNGLICHE FUNKTIONEN =====

        // Pizza Loading Animation
        function hidePizzaLoader() {
            const loader = document.getElementById('pizzaLoader');
            setTimeout(() => {
                loader.classList.add('hidden');
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
            }, 1500);
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i> 
                ${message}
            `;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Foodtruck Status laden
        function loadFoodtruckStatus() {
            database.ref('settings/foodtruckOpen').on('value', (snapshot) => {
                foodtruckOpen = snapshot.val() || false;
                updateUI();
                
                if (foodtruckOpen) {
                    loadProducts();
                    monitorProductCount();
                    monitorAdminWaitTimeSettings();
                }
            });
        }

        // UI Status aktualisieren
        function updateUI() {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            const closedMessage = document.getElementById('closedMessage');
            const productsSection = document.getElementById('productsSection');
            const waitTimeBanner = document.getElementById('waitTimeBanner');
            
            if (foodtruckOpen) {
                statusText.textContent = 'Ge√∂ffnet';
                statusBadge.style.background = 'rgba(34, 197, 94, 0.2)';
                statusBadge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                statusBadge.style.color = '#22c55e';
                
                closedMessage.style.display = 'none';
                productsSection.style.display = 'block';
                waitTimeBanner.style.display = 'block';
            } else {
                statusText.textContent = 'Geschlossen';
                statusBadge.style.background = 'rgba(239, 68, 68, 0.2)';
                statusBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusBadge.style.color = '#ef4444';
                
                closedMessage.style.display = 'block';
                productsSection.style.display = 'none';
                waitTimeBanner.style.display = 'none';
            }
        }

        // Produkte laden
        function loadProducts() {
            database.ref('products').on('value', (snapshot) => {
                availableProducts = snapshot.val() || {};
                renderProducts();
            });
        }

        // Produkte rendern
        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const products = Object.entries(availableProducts).filter(([_, product]) => product.available);
            
            if (products.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6);">Keine Produkte verf√ºgbar</p>';
                return;
            }
            
            grid.innerHTML = products.map(([id, product]) => `
                <div class="product-card" data-product="${id}">
                    <div class="product-info">
                        <div class="product-emoji">${product.category === 'pizza' ? 'üçï' : 'üçù'}</div>
                        <div class="product-details">
                            <h3>${product.name}</h3>
                            <div class="product-price">CHF ${product.price.toFixed(2)}</div>
                        </div>
                    </div>
                    <p class="product-description">${product.description}</p>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="updateCart('${id}', -1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="quantity-display" id="qty-${id}">0</span>
                        <button class="quantity-btn" onclick="updateCart('${id}', 1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Warenkorb aktualisieren
        function updateCart(productId, change) {
            if (!cart[productId]) cart[productId] = 0;
            cart[productId] = Math.max(0, cart[productId] + change);
            
            if (cart[productId] === 0) {
                delete cart[productId];
            }
            
            document.getElementById(`qty-${productId}`).textContent = cart[productId] || 0;
            updateCartDisplay();
        }

        // Warenkorb-Anzeige aktualisieren
        function updateCartDisplay() {
            const cartSection = document.getElementById('cartSection');
            const cartItems = document.getElementById('cartItems');
            const totalPrice = document.getElementById('totalPrice');
            const orderBtn = document.getElementById('orderBtn');
            const noteSection = document.getElementById('noteSection');
            
            const items = Object.entries(cart);
            
            if (items.length === 0) {
                cartSection.classList.remove('visible');
                noteSection.style.display = 'none';
                orderBtn.disabled = true;
                orderBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Produkt ausw√§hlen';
                return;
            }
            
            cartSection.classList.add('visible');
            noteSection.style.display = 'block';
            
            let total = 0;
            cartItems.innerHTML = items.map(([productId, quantity]) => {
                const product = availableProducts[productId];
                const itemTotal = product.price * quantity;
                total += itemTotal;
                
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${product.name}</div>
                            <div class="cart-item-details">${quantity}x CHF ${product.price.toFixed(2)}</div>
                        </div>
                        <div class="cart-item-price">CHF ${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
            
            totalPrice.textContent = `CHF ${total.toFixed(2)}`;
            
            const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
            orderBtn.disabled = false;
            orderBtn.innerHTML = `<i class="fas fa-shopping-cart"></i> Bestellen (${itemCount} ${itemCount === 1 ? 'Artikel' : 'Artikel'})`;
        }

        // Bestellung abschicken
        document.getElementById('orderBtn').addEventListener('click', async () => {
            if (Object.keys(cart).length === 0) return;

            const loading = document.getElementById('loading');
            const btn = document.getElementById('orderBtn');
            
            loading.style.display = 'block';
            btn.disabled = true;

            try {
                // Bestelldaten zusammenstellen
                const orderItems = Object.entries(cart).map(([productId, quantity]) => ({
                    id: productId,
                    name: availableProducts[productId].name,
                    price: availableProducts[productId].price,
                    quantity: quantity,
                    total: availableProducts[productId].price * quantity
                }));

                const subtotal = orderItems.reduce((sum, item) => sum + item.total, 0);
                const orderId = `D${Date.now().toString().slice(-8)}`;

                const orderData = {
                    id: orderId,
                    items: orderItems,
                    paymentMethod: 'cash',
                    deliveryType: 'pickup',
                    note: document.getElementById('orderNote').value.trim(),
                    timestamp: new Date().toISOString(),
                    status: 'neu',
                    subtotal: subtotal,
                    total: subtotal
                };

                // Bestellung in Firebase speichern
                await database.ref('orders').push(orderData);
                
                // Lokale Bestellungs-ID f√ºr Tracking speichern
                localStorage.setItem('currentOrderId', orderId);
                localStorage.setItem('orderTimestamp', Date.now().toString());
                
                // Push-Benachrichtigungen f√ºr diese Bestellung einrichten
                const orderKey = Object.keys((await database.ref('orders').orderByChild('id').equalTo(orderId).once('value')).val())[0];
                if (orderKey) {
                    monitorOrderStatus(orderKey);
                }
                
                // Erfolgs-Benachrichtigung
                const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
                getTotalActiveProducts().then(totalProducts => {
                    const waitTime = calculateWaitTime(totalProducts + itemCount);
                    showNotification(
                        `‚úÖ Bestellung #${orderId} eingegangen! Gesch√§tzte Wartezeit: ${waitTime.text} Min`, 
                        'success'
                    );
                });
                
                // Warenkorb leeren
                cart = {};
                updateCartDisplay();
                Object.keys(availableProducts).forEach(id => {
                    const qtyElement = document.getElementById(`qty-${id}`);
                    if (qtyElement) qtyElement.textContent = '0';
                });
                
                // 9. TRACKING-POPUP ANZEIGEN
                setTimeout(() => {
                    if (confirm('M√∂chten Sie Ihre Bestellung verfolgen?')) {
                        showOrderTracking(orderId);
                    }
                }, 2000);

            } catch (error) {
                console.error('Fehler bei der Bestellung:', error);
                showNotification('Fehler bei der Bestellung. Bitte versuchen Sie es erneut.', 'error');
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        });

        // 9. BESTELLVERFOLGUNG ANZEIGEN
        async function showOrderTracking(orderId) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            const trackingCard = document.createElement('div');
            trackingCard.style.cssText = `
                background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
                border-radius: 24px; padding: 40px; max-width: 400px; width: 100%;
                text-align: center; color: white; position: relative;
            `;
            
            const totalProducts = await getTotalActiveProducts();
            const waitTime = calculateWaitTime(totalProducts);
            
            trackingCard.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 1.5rem; cursor: pointer;">√ó</button>
                <div style="font-size: 3rem; margin-bottom: 20px;">üçï</div>
                <h2 style="color: #22c55e; margin-bottom: 10px;">Bestellung eingegangen!</h2>
                <p style="font-size: 1.1rem; margin-bottom: 20px;">Bestellung #${orderId}</p>
                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <div style="font-size: 2rem; color: #22c55e; font-weight: bold;">${waitTime.text} Min</div>
                    <div style="color: rgba(255,255,255,0.8);">Gesch√§tzte Wartezeit</div>
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-top: 8px;">
                        <i class="fas fa-pizza-slice"></i> ${totalProducts} Produkte in Zubereitung
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin: 20px 0;">
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">Sie erhalten eine Benachrichtigung, wenn Ihre Bestellung fertig ist.</div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 10px;">Verstanden</button>
            `;
            
            overlay.appendChild(trackingCard);
            document.body.appendChild(overlay);
        }

        // Admin Login
        function goToLogin() {
            window.location.href = 'login.html';
        }

        // App initialisieren
        async function initApp() {
            await setupPushNotifications();
            loadFoodtruckStatus();
            hidePizzaLoader();
            
            // Pr√ºfe ob eine aktive Bestellung existiert
            const currentOrderId = localStorage.getItem('currentOrderId');
            const orderTimestamp = localStorage.getItem('orderTimestamp');
            
            if (currentOrderId && orderTimestamp) {
                const orderAge = (Date.now() - parseInt(orderTimestamp)) / (1000 * 60);
                if (orderAge < 120) {
                    database.ref('orders').orderByChild('id').equalTo(currentOrderId).once('value', (snapshot) => {
                        const orders = snapshot.val();
                        if (orders) {
                            const orderKey = Object.keys(orders)[0];
                            const order = orders[orderKey];
                            if (order.status !== 'fertig' && order.status !== 'abgeholt') {
                                monitorOrderStatus(orderKey);
                                showNotification(`Ihre Bestellung #${currentOrderId} wird √ºberwacht`, 'info');
                            }
                        }
                    });
                }
            }
        }

        // App starten
        initApp();
    </script>
</body>
</html>